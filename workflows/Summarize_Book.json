{
  "updatedAt": "2025-12-03T16:31:07.000Z",
  "createdAt": "2025-10-11T05:01:27.901Z",
  "id": "HMsQ8Guu6LkHJ85Q",
  "name": "Summarize Book",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "content": "## Load Book from Vector Store, summarize",
        "height": 448,
        "width": 976,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -672,
        -240
      ],
      "id": "ce84b2c8-0d09-4e97-b8eb-3bfd5b77da38",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\nconst chapters = data.chapters_summary || [];\nconst bookSummary = data.complete_book_summary || \"\";\nconst bookTitle = data.book_title || \"Study Workbook\";\nconst accent = \"#264653\"; // teal accent (kept if you still want headers accented)\n\n// Helper to clean chapter titles\nfunction cleanTitle(title = \"\", index) {\n  return title.replace(/^(Chapter\\s*\\d+[:.\\-]?\\s*|[0-9IVXLCDM]+\\s+)/i, \"\").trim();\n}\n\n// Build Table of Contents\nconst toc = chapters.map(ch => `<li>${cleanTitle(ch.title)}</li>`).join(\"\");\n\n// Build global index\nconst indexEntries = [];\n\nlet title = $(\"Merge\").first().json.title;\nlet author = $(\"Merge\").first().json.author;\n\nlet html = `\n<html>\n<head>\n  <style>\n    :root { --accent: ${accent}; }\n    body {\n      font-family: \"Helvetica Neue\", Arial, sans-serif;\n      padding: 40px;\n      background: #FFFFFF;\n      color: #000000;\n      line-height: 1.6;\n    }\n    h1, h2, h3 { color: var(--accent); }\n    h1 {\n      text-align: center;\n      border-bottom: 3px solid var(--accent);\n      padding-bottom: 10px;\n      margin-bottom: 30px;\n    }\n    h2 {\n      border-bottom: 1px solid #000000;\n      padding-bottom: 4px;\n      margin-top: 40px;\n      color: #000000;\n    }\n    h3 { margin-top: 25px; color: #000000; }\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-top: 15px;\n      font-size: 0.95em;\n      background: #FFFFFF;\n      color: #000000;\n    }\n    td, th {\n      border: 1px solid #000000;\n      padding: 8px;\n      vertical-align: top;\n    }\n    th {\n      background: #FFFFFF;\n      font-weight: bold;\n    }\n    tr:nth-child(even) td { background: #FFFFFF; }\n    .chapter {\n      page-break-before: always;\n      margin-top: 60px;\n    }\n    .summary { margin-top: 10px; margin-bottom: 20px; }\n    .cover {\n      text-align: center;\n      page-break-after: always;\n      margin-top: 200px;\n    }\n    footer {\n      margin-top: 50px;\n      text-align: center;\n      font-size: 0.8em;\n      color: #000000;\n      border-top: 1px solid #000000;\n      padding-top: 10px;\n    }\n    ol { margin-left: 25px; color: #000000; }\n    .answer-space {\n      border-bottom: 1px solid #000000;\n      height: 25px;\n      margin: 5px 0 15px;\n    }\n  </style>\n</head>\n<body>\n\n  <!-- Cover Page -->\n  <div class=\"cover\">\n    <h1>${title}</h1>\n    <h2>${author}</h2>\n    <p>Workbook Summary</p>\n    <p><em>Generated by Megyk Books</em></p>\n  </div>\n\n  <!-- Table of Contents -->\n  <h2>Table of Contents</h2>\n  <ol>${toc}</ol>\n`;\n\n// Loop through chapters\nfor (const ch of chapters) {\n  const questions = ch.questions || [];\n  const answers = ch.answers || [];\n\n  // Add to global index\n  questions.forEach((q, i) => {\n    indexEntries.push({\n      chapter_index: ch.chapter_index,\n      chapter_title: cleanTitle(ch.title),\n      question: q,\n      answer: answers[i] || \"\"\n    });\n  });\n\n  html += `\n  <div class=\"chapter\">\n    <h2>Chapter ${ch.chapter_index + 1}: ${cleanTitle(ch.title)}</h2>\n    ${ch.summary ? `<div class=\"summary\"><p>${ch.summary}</p></div>` : \"\"}\n    \n    ${questions.length ? `\n      <h3>Questions for Reflection</h3>\n      <ol>\n        ${questions.map(q => `\n          <li>${q}\n            <div class=\"answer-space\"></div>\n            <div class=\"answer-space\"></div>\n          </li>`).join(\"\")}\n      </ol>\n    ` : \"\"}\n  </div>`;\n}\n\n// Add complete book summary\nhtml += `\n  <div class=\"chapter\">\n    <h2>Complete Book Summary</h2>\n    <p>${bookSummary}</p>\n  </div>\n`;\n\n// Add global Q&A Index\nif (indexEntries.length) {\n  html += `\n  <div class=\"chapter\">\n    <h2>Workbook Index â€” All Questions & Answers</h2>\n    <table>\n      <tr><th>Chapter</th><th>Question</th><th>Answer</th></tr>`;\n\n  let lastChapter = \"\";\n  for (const e of indexEntries) {\n    const chapterLabel = e.chapter_title !== lastChapter\n      ? `Chapter ${e.chapter_index + 1}: ${e.chapter_title}`\n      : \"\";\n    html += `\n      <tr>\n        <td>${chapterLabel}</td>\n        <td>${e.question}</td>\n        <td>${e.answer}</td>\n      </tr>`;\n    lastChapter = e.chapter_title;\n  }\n\n  html += `\n    </table>\n  </div>`;\n}\n\n// Footer\nhtml += `\n  <footer>\n    Generated on ${new Date().toLocaleDateString()} by Megyk Books\n  </footer>\n</body>\n</html>\n`;\n\nreturn [{ html }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1824,
        160
      ],
      "id": "be5d1f67-e491-43ba-b1a9-04a75321d33d",
      "name": "Generate Workbook HTML"
    },
    {
      "parameters": {
        "jsCode": "return $input.first().json.output;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1280,
        160
      ],
      "id": "f9d33d5b-adf6-46dd-bb63-346c1bf8fe40",
      "name": "Parse Content"
    },
    {
      "parameters": {
        "jsCode": "// Get the LLM message content (handle array or object safely)\nlet raw = $json;\nif (Array.isArray(raw)) raw = raw[0];\nraw = typeof raw === 'string' ? raw : JSON.stringify(raw);\n\n// Step 1 â€” Remove code fences and trim\nraw = raw.replace(/^```(?:json)?/i, '').replace(/```$/, '').trim();\n\n\n// Step 2 â€” If double-encoded, unescape once\nif (raw.startsWith('\"') && raw.endsWith('\"')) {\n  try {\n    raw = JSON.parse(raw);\n  } catch (e) {\n    // ignore if not actually double encoded\n  }\n}\n\n// Step 3 â€” Find the last closing bracket before trailing junk\nconst lastSquare = raw.lastIndexOf(']');\nconst lastCurly = raw.lastIndexOf('}');\nconst cutoff = Math.max(lastSquare, lastCurly);\nif (cutoff !== -1) raw = raw.slice(0, cutoff + 1);\n\n// Step 4 â€” Attempt to parse the clean portion\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (err) {\n  // If it still fails, try to extract both array and trailing summary manually\n  const match = raw.match(/(\\[.*\\])\\s*,\\s*({.*})/s);\n  if (match) {\n    try {\n      const chapters = JSON.parse(match[1]);\n      const summary = JSON.parse(match[2]);\n      parsed = { chapters, summary };\n    } catch (e2) {\n      parsed = { error: e2.message, snippet: raw.slice(0, 500) };\n    }\n  } else {\n    parsed = { error: err.message, snippet: raw.slice(0, 500) };\n  }\n}\n\nreturn parsed;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        160
      ],
      "id": "bdb72177-f9d7-498d-bfc6-ab92fc06d296",
      "name": "parse Workbook"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.preferences.style }}",
                    "rightValue": "narrative",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f73cb591-f577-431d-9a62-a7911e625676"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "narrative"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5216c0fa-a23c-43d5-9df7-b6872a407df4",
                    "leftValue": "={{ $json.preferences.style }}",
                    "rightValue": "bullet_points",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "bullet_points"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "82fc4562-66cb-4690-bece-a5aff5c322e3",
                    "leftValue": "={{ $json.preferences.style }}",
                    "rightValue": "workbook",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "workbook"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        528,
        -96
      ],
      "id": "cbbb4f30-2a86-4f74-86cf-fa75d7cac1da",
      "name": "Summary Type"
    },
    {
      "parameters": {
        "jsCode": "/* FULL CODE NODE â€” READY TO PASTE INTO n8n */\n\nconst data = items[0].json;\nconst chapters = data.chapters_summary || data.chapters_summaries || [];\nconst prefs = data.user_preferences || {};\nconst summary = data.complete_book_summary || \"\";\n\nfunction escapeHTML(str = \"\") {\n  return String(str)\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\");\n}\n\nfunction cleanTitle(ch, withNumber = false) {\n  let title = ch.title || \"\";\n  title = title.replace(/^(Chapter\\s*\\d+[:.\\-]?\\s*|[0-9IVXLCDM]+\\s+)/i, \"\").trim();\n  return withNumber ? `Chapter ${ch.chapter_index + 1}: ${title}` : title;\n}\n\n// Pure black for workbook mode\nconst accent = \"#000000\";\n\nlet title = $(\"Merge\").first().json.title;\nlet author = $(\"Merge\").first().json.author;\n\nlet html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>${escapeHTML(title)}</title>\n  <style>\n    body {\n      font-family: \"Georgia\", serif;\n      margin: 0.6in 0.85in;  /* ðŸ”¥ Tighter left/right margins */\n      line-height: 1.7;\n      color: #000;\n      background: #fff;\n    }\n\n    h1, h2, h3 {\n      text-align: center;\n      color: #000;\n    }\n\n    h1 {\n      font-size: 2.4em;\n      border-bottom: 3px solid #000;\n      padding-bottom: 0.3em;\n      margin-bottom: 0.5em;\n    }\n\n    h2 {\n      font-size: 1.4em;\n      margin-top: 2.2em;\n      margin-bottom: 0.4em;\n      border-bottom: 1px solid #000;\n      padding-bottom: 0.2em;\n    }\n\n    h3 {\n      font-size: 1.25em;\n      margin-top: 1.6em;\n      margin-bottom: 0.4em;\n      font-weight: bold;\n    }\n\n    p {\n      text-align: justify;\n      margin: 0.7em 0;\n      text-indent: 1.2em;\n      color: #000;\n      font-size: 1.05em;\n    }\n\n    /* Removed drop-cap â€” replaced with clean first-word emphasis */\n    p:first-line {\n      font-weight: 600;\n      letter-spacing: 0.3px;\n      font-size: 1.06em;\n    }\n\n    .summary-intro {\n      background: #fff;\n      border-left: 4px solid #000;\n      padding: 1em 1.5em;\n      margin: 1.5em auto 2em;\n      width: 85%;\n    }\n\n    #toc {\n      background: #fff;\n      border: 1px solid #000;\n      padding: 1em;\n      margin: 2em auto;\n      width: 80%;\n    }\n\n    article {\n      margin-top: 1.8em;\n      padding-top: 1em;\n      border-top: 2px solid #000;\n      background: #fff;\n    }\n\n    footer {\n      text-align: center;\n      margin-top: 3em;\n      font-size: 0.85em;\n      border-top: 1px solid #000;\n      padding-top: 10px;\n    }\n\n    @page {\n      margin: 0.6in 0.7in;\n    }\n\n    @media print {\n      body { margin: 0; }\n      article { page-break-inside: avoid; }\n      #toc, #overview { page-break-inside: avoid; }\n      #overview {\n        page-break-inside: auto !important;\n      }\n\n    }\n  </style>\n</head>\n<body>\n\n  <section id=\"cover\">\n    <h1>${escapeHTML(title)}</h1>\n    <h3>${escapeHTML(author)}</h3>\n    <h3>Megyk Books Summary â€” Narrative Style</h3> \n  </section>\n\n  <section id=\"overview\">\n    <h2>Overview</h2>\n    <p>${escapeHTML(summary)}</p>\n  </section>\n\n  <section id=\"toc\">\n    <h2>Table of Contents</h2>\n    <ol>\n      ${chapters.map(ch => `<li>${escapeHTML(cleanTitle(ch, false))}</li>`).join(\"\")}\n    </ol>\n  </section>\n\n  <section id=\"chapters\">\n    <h2>Chapters</h2>\n`;\n\nfor (const ch of chapters) {\n  html += `\n    <article>\n      <h3>${escapeHTML(cleanTitle(ch, false))}</h3>\n      <p>${escapeHTML(ch.summary)}</p>\n    </article>\n  `;\n}\n\nhtml += `\n  </section>\n\n  <footer>\n    Generated by <strong>Megyk Books</strong> â€” ${new Date().toLocaleDateString()}\n  </footer>\n\n</body>\n</html>\n`;\n\nreturn [{ json: { html } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        -320
      ],
      "id": "362e4f44-8f68-415b-bfe8-bea99fdb7cad",
      "name": "Generate Narrative HTML"
    },
    {
      "parameters": {
        "jsCode": "// Input: { user_preferences, chapters_summary[], complete_book_summary }\n// Output: { html: \"<html>...</html>\" }\n\nconst data = items[0].json;\nconst prefs = data.user_preferences || {};\nconst chapters = data.chapters_summary || [];\nconst summary = data.complete_book_summary || \"\";\n\nfunction toList(content) {\n  if (!content) return \"\";\n  if (Array.isArray(content)) {\n    return `<ul>${content.map(b => `<li>${b.trim()}</li>`).join(\"\\n\")}</ul>`;\n  }\n  const sentences = content\n    .split(/(?<=[.?!])\\s+/)\n    .map(s => s.trim())\n    .filter(Boolean);\n  return `<ul>${sentences.map(s => `<li>${s}</li>`).join(\"\\n\")}</ul>`;\n}\n\nfunction cleanTitle(ch, withNumber = false) {\n  let title = ch.title || \"\";\n  title = title.replace(/^(Chapter\\s*\\d+[:.\\-]?\\s*|[0-9IVXLCDM]+\\s+)/i, \"\").trim();\n  return withNumber ? `Chapter ${ch.chapter_index + 1}: ${title}` : title;\n}\n\nfunction accentColor(length) {\n  switch (length) {\n    case \"1pg\": return \"#000000\";\n    case \"15pg\": return \"#000000\";\n    default: return \"#000000\";\n  }\n}\nconst accent = accentColor(prefs.length);\n\nlet title = $(\"Merge\").first().json.title;\nlet author = $(\"Merge\").first().json.author;\n\nlet html = `\n<!DOCTYPE html>\n<html>\n<head>\n<meta charset=\"utf-8\">\n<title>${title}</title>\n<style>\n  body {\n    font-family: \"Helvetica Neue\", Arial, sans-serif;\n    margin: 1in;\n    line-height: 1.6;\n    color: #000000;\n    background: #FFFFFF;\n  }\n  h1, h2, h3 { color: #000000; }\n  h1 {\n    text-align: center;\n    border-bottom: 3px solid #000000;\n    padding-bottom: 10px;\n    margin-bottom: 30px;\n    font-size: 2.2em;\n  }\n  h2 {\n    color: #000000;\n    border-bottom: 1px solid #000000;\n    padding-bottom: 4px;\n    margin-bottom: 0.6em;\n    margin-top: 2em;\n    font-size: 1.3em;\n  }\n  h3 {\n    color: #000000;\n    margin-top: 1.5em;\n    font-size: 1.1em;\n  }\n  ul {\n    list-style-type: disc;\n    margin-left: 1.5em;\n    line-height: 1.5;\n    color: #000000;\n  }\n  li { margin-bottom: 0.3em; color: #000000; }\n  .prefs {\n    background: #FFFFFF;\n    border-left: 4px solid #000000;\n    padding: 1em;\n    margin-bottom: 2em;\n    border-radius: 0;\n  }\n  #overall, #toc, article {\n    page-break-inside: avoid;\n  }\n  #overall {\n    background: #FFFFFF;\n    border-left: 4px solid #000000;\n    padding: 1.2em;\n    border-radius: 0;\n    margin-bottom: 2em;\n  }\n  #toc {\n    background: #FFFFFF;\n    border: 1px solid #000000;\n    border-radius: 0;\n    padding: 1em;\n    margin-bottom: 2em;\n    color: #000000;\n  }\n  #toc h2 {\n    border: none;\n    color: #000000;\n    margin-bottom: 0.5em;\n  }\n  #toc ol {\n    margin-left: 1.5em;\n    line-height: 1.5;\n    color: #000000;\n  }\n  #chapters {\n    page-break-before: always;\n  }\n  article {\n    margin-top: 2em;\n    padding: 1em;\n    border-top: 2px solid #000000;\n    background: #FFFFFF;\n    color: #000000;\n  }\n  article:nth-child(even) {\n    background: #FFFFFF;\n  }\n  footer {\n    margin-top: 50px;\n    text-align: center;\n    font-size: 0.8em;\n    color: #000000;\n    border-top: 1px solid #000000;\n    padding-top: 10px;\n  }\n  footer strong { color: #000000; }\n\n\n    @page {\n      margin: 0.6in 0.7in;\n    }\n\n  @media print {\n    body { margin: 0; }\n    h1, h2, h3, li, p { color: #000000 !important; background: #FFFFFF !important; }\n    #overall, #toc, article { page-break-inside: avoid; }\n    #chapters { page-break-before: always; }\n  }\n</style>\n</head>\n<body>\n\n<h1>${title}</h1>\n<h2>${author}</h2>\n\n<div class=\"prefs\">\n  <p><strong>Style:</strong> ${prefs.style || \"bullet_points\"}</p>\n  <p><strong>Target Length:</strong> ${prefs.length || \"unspecified\"}</p>\n</div>\n\n<section id=\"overall\">\n  <h2>Overall Summary</h2>\n  ${toList(summary)}\n</section>\n\n<section id=\"toc\">\n  <h2>Table of Contents</h2>\n  <ol>\n    ${chapters.map(ch => `<li>${cleanTitle(ch, false)}</li>`).join(\"\\n\")}\n  </ol>\n</section>\n\n<section id=\"chapters\">\n  <h2>Chapters</h2>\n`;\n\nfor (const ch of chapters) {\n  const bullets = ch.summary_bullets || ch.summary || [];\n  html += `\n  <article>\n    <h3>${cleanTitle(ch, false)}</h3>\n    ${toList(bullets)}\n  </article>\n  `;\n}\n\nhtml += `\n</section>\n\n<footer>\n  <p>Generated by <strong>Megyk Books</strong> â€” ${new Date().toLocaleDateString()}</p>\n</footer>\n\n</body>\n</html>\n`;\n\nreturn [{ json: { html } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        -80
      ],
      "id": "305e4c5c-ced5-483e-9765-d62a136555c3",
      "name": "Generate Bullet Points HTML"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"user_preferences\": {\"style\": \"workbook\", \"length\": \"5pg\"},\n  \"chapters_summary\": [\n    {\n      \"chapter_index\": 1,\n      \"title\": \"Chapter Title\",\n      \"summary\": \"Short paragraph summary.\",\n      \"questions\": [\"Question 1\", \"Question 2\"],\n      \"answers\": [\"Answer 1\", \"Answer 2\"]\n    }\n  ],\n  \"complete_book_summary\": \"Overall workbook summary text.\",\n  \"index\": [\n    {\"question\": \"Question 1\", \"answer\": \"Answer 1\"},\n    {\"question\": \"Question 2\", \"answer\": \"Answer 2\"}\n  ]\n}\n",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1232,
        416
      ],
      "id": "d57816ff-032b-45c5-bcb4-50c87f829882",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {
          "temperature": 0.2,
          "timeout": 600000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        736,
        416
      ],
      "id": "ed35e3be-5b57-4f47-bb59-af1786c7c4ee",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "BRRf66J5aSwt4UDP",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Summarize this book in narrative style using the data retrieved from the Get Chapters tool in accordance with the following preferences object: {{ JSON.stringify($json.preferences) }}\n\nBook Title is: {{ $json.title }}\nAuthor is: {{ $json.author }}\n\n1. Call Get Chapters to fetch all chapters where book_id = {{ $json.book_id }}.\n2. Summarize each chapter as immersive, flowing prose (not meta commentary).\n3. At the end, include a cohesive full-book narrative summary.\n4. Adjust level of detail according to the user_preferences.length value:\n\n- \"1pg\": 1 sentence per chapter; 1 short paragraph overall summary.\n- \"5pg\": ~50-100 words per chapter; 2â€“3 paragraphs overall summary.\n- \"15pg\": 1 page per chapter; multi-paragraph in-depth summary.\n\nReturn only structured JSON matching the format defined in the system prompt.\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=You are a summarization model that writes cohesive, immersive, narrative-style summaries of books.\n\nYou have access to:\n- Get Chapters â€” use this to load all chapters for a given book_id.\n\nThere is an incoming user_preferences object (e.g. {\"style\":\"narrative\",\"length\":\"5pg\"}).\nUse it to adjust tone and detail level.\n\nGuidelines:\n- Write in flowing narrative prose as if retelling the book directly to the reader.\n- Do not say â€œThis chapter discussesâ€¦â€ or â€œThe author explainsâ€¦â€ â€” simply convey the ideas themselves.\n- Write as if you are condensing the book itself, not describing it.\n- Maintain consistent voice and tense throughout.\n- Be accurate, concise, and engaging.\n\nOutput only structured JSON in the format:\n{\n  \"user_preferences\": {...},\n  \"chapters_summary\": [\n    {\"chapter_index\": 1, \"title\": \"Chapter 1\", \"summary\": \"Narrative paragraph...\"}\n  ],\n  \"complete_book_summary\": \"Full book-level narrative summary.\"\n}\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        864,
        -320
      ],
      "id": "7e72b5ca-49f2-47d2-8b52-c0cae6909656",
      "name": "Narrative Summary Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Call Get Chapters to retrieve all chapters for the specified book_id: {{ $json.book_id }}\n\nYou have access to the following user preferences object:\n{{ JSON.stringify($json.preferences) }}\n\nBook Title is: {{ $json.title }}\nAuthor is: {{ $json.author }}\n\n\nSummarize each chapter as a list of concise bullet points.\n\nUse the \"length\" parameter to control the level of detail:\n- \"1pg\": Very short â€” 2â€“4 bullets per chapter, focusing only on the core message.\n- \"5pg\": Moderate â€” 6â€“10 bullets per chapter, capturing key ideas and examples.\n- \"15pg\": Extensive â€” 12â€“20 bullets per chapter, covering subtopics, supporting evidence, and nuanced insights.\n\nAt the end, include a bullet-point list of overarching takeaways, scaled to the same level of detail.\n\nReturn JSON in this format:\n{\n  \"user_preferences\": {\"style\": \"bullet_points\", \"length\": \"5pg\"},\n  \"chapters_summary\": [\n    {\"chapter_index\": 1, \"title\": \"Chapter Title\", \"summary_bullets\": [\"â€¢ point 1\", \"â€¢ point 2\", \"â€¢ point 3\"]}\n  ],\n  \"complete_book_summary\": [\"â€¢ main insight 1\", \"â€¢ main insight 2\", \"â€¢ main insight 3\"]\n}\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a summarization model that produces high-level bullet point summaries of each chapter of a book.\nYou have access to:\n- Get Chapters â€” use this to load all chapters for a given book_id.\n\nDo not include conversational framing. Respond strictly in JSON matching the example structure."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        864,
        -80
      ],
      "id": "6b3a9bac-a63d-4ae3-9af9-c439f84667f1",
      "name": "Bullet Points Summary Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Call Get Chapters to retrieve all chapters for the specified book_id: {{ $json.book_id }}\n\nYou have access to the following user preferences object:\n{{ JSON.stringify($json.preferences) }}\n\nBook Title is: {{ $json.title }}\nAuthor is: {{ $json.author }}\n\n\nSummarize each chapter as a clear, workbook-style study section. For each chapter:\n- Write a summary scaled to the \"length\" preference.\n- Generate comprehension questions and concise answers, as follows:\n  - \"1pg\": 1â€“2 simple comprehension questions.\n  - \"5pg\": 3â€“5 moderate-depth questions covering key ideas and examples.\n  - \"15pg\": 6â€“8 in-depth questions exploring reasoning, implications, and context.\n\nAfter summarizing all chapters, include:\n- A \"complete_book_summary\" â€” a brief synthesis of the book as a whole, scaled to the same level of detail.\n- An \"index\" array mapping every question and answer pair across all chapters.\n\nReturn JSON strictly in this format:\n{\n  \"user_preferences\": {\"style\": \"workbook\", \"length\": \"5pg\"},\n  \"chapters_summary\": [\n    {\n      \"chapter_index\": 1,\n      \"title\": \"Chapter Title\",\n      \"summary\": \"Short descriptive paragraph(s)\",\n      \"questions\": [\"Question 1\", \"Question 2\"],\n      \"answers\": [\"Answer 1\", \"Answer 2\"]\n    }\n  ],\n  \"complete_book_summary\": \"Concise book overview\",\n  \"index\": [{\"question\": \"Question 1\", \"answer\": \"Answer 1\"}]\n}\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=You are an educational summarization model that generates workbook-style study guides.\n\nTools:\n- Get Chapters â€” fetches chapters by book_id.\n\nInstructions:\n1. Summarize each chapter clearly and briefly, adjusting depth based on user_preferences.length.\n2. Generate comprehension questions and concise answers. The number of questions should scale by length:\n   - \"1pg\": 1â€“2 simple comprehension questions.\n   - \"5pg\": 3â€“5 medium-depth questions covering key ideas.\n   - \"15pg\": 6â€“8 in-depth questions that explore examples, reasoning, and implications.\n3. Append a combined \"index\" mapping all questions and answers.\n4. Respect the provided user_preferences object for style and length.\n5. Limit each summary to 1â€“2 short paragraphs for \"1pg\", up to 3 for \"5pg\", and up to 5 for \"15pg\".\n\nOutput strictly as JSON in this shape:\n{\n  \"user_preferences\": {...},\n  \"chapters_summary\": [\n    {\n      \"chapter_index\": 1,\n      \"title\": \"...\",\n      \"summary\": \"...\",\n      \"questions\": [\"...\"],\n      \"answers\": [\"...\"]\n    }\n  ],\n  \"complete_book_summary\": \"...\",\n  \"index\": [{\"question\": \"...\", \"answer\": \"...\"}]\n}\n\nGuidelines:\n- Avoid prefatory or conversational text.\n- Prefer clarity and educational usefulness over literary style.\n- Make questions and answers self-contained and directly tied to the chapterâ€™s ideas.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        864,
        160
      ],
      "id": "260cab7c-7f91-49dc-a142-a44e1084a754",
      "name": "Workbook Agent",
      "retryOnFail": false
    },
    {
      "parameters": {
        "jsCode": "return JSON.parse( $input.first().json.output);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1280,
        -80
      ],
      "id": "49968360-b149-46da-a157-b598e3cea933",
      "name": "Parse Output"
    },
    {
      "parameters": {
        "jsCode": "return JSON.parse( $input.first().json.output);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1280,
        -320
      ],
      "id": "d08aee05-f94a-4635-92cd-290551b8a2c1",
      "name": "Parse Output1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "get_book_summary",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -592,
        -64
      ],
      "id": "1ab0665d-531f-4272-bd9a-e65642f382da",
      "name": "Webhook",
      "webhookId": "057f4390-ae36-4e89-81ea-78d92b2a53b9"
    },
    {
      "parameters": {
        "respondWith": "binary",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/pdf"
              },
              {
                "name": "Content-Disposition",
                "value": "attachment; filename=\"document.pdf\""
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        2560,
        -80
      ],
      "id": "c3fb6559-f2bf-4186-baae-e24a5652b591",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "// Extract the body payload from the webhook input\nconst body = items[0].json.body;\n\nreturn [\n  {\n    json: {\n      book_id: body.book_id,     // maps from book_id\n      user_id: 'bfb1e2f2-353c-4cf7-807e-4be63ed7cfff',        // placeholder if not provided\n      preferences: body.preferences\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        -64
      ],
      "id": "52dd94ac-dec8-4cb7-b5c6-3c88b36b9c2f",
      "name": "Parse Incoming"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "chapters",
        "filters": {
          "conditions": [
            {
              "keyName": "book_id",
              "condition": "eq",
              "keyValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Field_Value', ``, 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        992,
        416
      ],
      "id": "0949ffd9-d2bd-4c69-8e4f-5a4edcbb85b6",
      "name": "Get Chapters",
      "credentials": {
        "supabaseApi": {
          "id": "fdzgJDGuPA2JozKn",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        720,
        128
      ],
      "id": "9da8e45b-fd0d-44b8-b895-a11345edec80",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "BRRf66J5aSwt4UDP",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        720,
        -112
      ],
      "id": "257ecacc-0eec-492f-9900-f805b26cfd82",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "BRRf66J5aSwt4UDP",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "id",
              "field2": "book_id"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        64,
        -80
      ],
      "id": "ed45a8aa-749f-4820-adc2-ee86696bb775",
      "name": "Merge"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "books",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.book_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -144,
        -192
      ],
      "id": "e378404a-2aa6-4b6f-ac42-aefb9eb16625",
      "name": "Load Book",
      "credentials": {
        "supabaseApi": {
          "id": "fdzgJDGuPA2JozKn",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1168,
        624
      ],
      "id": "3e98676d-c0f7-46e6-b2db-56ed11f4ac55",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "BRRf66J5aSwt4UDP",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://pdf.megyk.com/html-to-pdf",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "html",
              "value": "={{ $json.html }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2304,
        -80
      ],
      "id": "277822f1-04dc-4888-b616-495b8a71a7b8",
      "name": "HTML 2 PDF Service",
      "credentials": {
        "httpHeaderAuth": {
          "id": "AK2nObMbf1AjgZti",
          "name": "PDF Service API Key"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "93bcaa67-5d39-4eee-96ce-900e357530cc",
              "name": "html",
              "value": "={{ $json.html }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2048,
        -80
      ],
      "id": "dd4655d8-9d01-48ff-b84f-94823a0a971e",
      "name": "Edit Fields"
    }
  ],
  "connections": {
    "Generate Workbook HTML": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Content": {
      "main": [
        [
          {
            "node": "parse Workbook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parse Workbook": {
      "main": [
        [
          {
            "node": "Generate Workbook HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summary Type": {
      "main": [
        [
          {
            "node": "Narrative Summary Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Bullet Points Summary Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Workbook Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Narrative HTML": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Bullet Points HTML": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Workbook Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Workbook Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Bullet Points Summary Agent": {
      "main": [
        [
          {
            "node": "Parse Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Narrative Summary Agent": {
      "main": [
        [
          {
            "node": "Parse Output1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Workbook Agent": {
      "main": [
        [
          {
            "node": "Parse Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Output": {
      "main": [
        [
          {
            "node": "Generate Bullet Points HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Output1": {
      "main": [
        [
          {
            "node": "Generate Narrative HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse Incoming",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Incoming": {
      "main": [
        [
          {
            "node": "Load Book",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get Chapters": {
      "ai_tool": [
        [
          {
            "node": "Workbook Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Bullet Points Summary Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Narrative Summary Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Bullet Points Summary Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Narrative Summary Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Summary Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Book": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "HTML 2 PDF Service": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "HTML 2 PDF Service",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n.megyk.com",
            "user-agent": "node",
            "content-length": "189",
            "accept": "*/*",
            "accept-encoding": "br, gzip, deflate",
            "accept-language": "*",
            "content-type": "application/json",
            "sec-fetch-mode": "cors",
            "via": "1.1 Caddy",
            "x-forwarded-for": "161.35.17.133",
            "x-forwarded-host": "n8n.megyk.com",
            "x-forwarded-proto": "https"
          },
          "params": {},
          "query": {},
          "body": {
            "book_id": "04c7ac03-6d11-4ac6-ba3d-1d556ae8ba22",
            "preferences": {
              "style": "workbook",
              "length": "5pg"
            },
            "user_id": "1d87df06-f0d5-4192-a807-c4e19340fdd1",
            "timestamp": "2025-11-28T19:34:42.748Z"
          },
          "webhookUrl": "https://n8n.megyk.com/webhook/get_book_summary",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "e3dea5e4-1c56-4559-adee-539ef895c7ca",
  "activeVersionId": "e3dea5e4-1c56-4559-adee-539ef895c7ca",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-10-11T05:01:27.921Z",
      "createdAt": "2025-10-11T05:01:27.921Z",
      "role": "workflow:owner",
      "workflowId": "HMsQ8Guu6LkHJ85Q",
      "projectId": "B7QJE85HA2Vij1it"
    }
  ],
  "activeVersion": {
    "updatedAt": "2025-12-03T16:31:07.040Z",
    "createdAt": "2025-12-03T16:31:07.040Z",
    "versionId": "e3dea5e4-1c56-4559-adee-539ef895c7ca",
    "workflowId": "HMsQ8Guu6LkHJ85Q",
    "nodes": [
      {
        "parameters": {
          "content": "## Load Book from Vector Store, summarize",
          "height": 448,
          "width": 976,
          "color": 7
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -672,
          -240
        ],
        "id": "ce84b2c8-0d09-4e97-b8eb-3bfd5b77da38",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "jsCode": "const data = $json;\nconst chapters = data.chapters_summary || [];\nconst bookSummary = data.complete_book_summary || \"\";\nconst bookTitle = data.book_title || \"Study Workbook\";\nconst accent = \"#264653\"; // teal accent (kept if you still want headers accented)\n\n// Helper to clean chapter titles\nfunction cleanTitle(title = \"\", index) {\n  return title.replace(/^(Chapter\\s*\\d+[:.\\-]?\\s*|[0-9IVXLCDM]+\\s+)/i, \"\").trim();\n}\n\n// Build Table of Contents\nconst toc = chapters.map(ch => `<li>${cleanTitle(ch.title)}</li>`).join(\"\");\n\n// Build global index\nconst indexEntries = [];\n\nlet title = $(\"Merge\").first().json.title;\nlet author = $(\"Merge\").first().json.author;\n\nlet html = `\n<html>\n<head>\n  <style>\n    :root { --accent: ${accent}; }\n    body {\n      font-family: \"Helvetica Neue\", Arial, sans-serif;\n      padding: 40px;\n      background: #FFFFFF;\n      color: #000000;\n      line-height: 1.6;\n    }\n    h1, h2, h3 { color: var(--accent); }\n    h1 {\n      text-align: center;\n      border-bottom: 3px solid var(--accent);\n      padding-bottom: 10px;\n      margin-bottom: 30px;\n    }\n    h2 {\n      border-bottom: 1px solid #000000;\n      padding-bottom: 4px;\n      margin-top: 40px;\n      color: #000000;\n    }\n    h3 { margin-top: 25px; color: #000000; }\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-top: 15px;\n      font-size: 0.95em;\n      background: #FFFFFF;\n      color: #000000;\n    }\n    td, th {\n      border: 1px solid #000000;\n      padding: 8px;\n      vertical-align: top;\n    }\n    th {\n      background: #FFFFFF;\n      font-weight: bold;\n    }\n    tr:nth-child(even) td { background: #FFFFFF; }\n    .chapter {\n      page-break-before: always;\n      margin-top: 60px;\n    }\n    .summary { margin-top: 10px; margin-bottom: 20px; }\n    .cover {\n      text-align: center;\n      page-break-after: always;\n      margin-top: 200px;\n    }\n    footer {\n      margin-top: 50px;\n      text-align: center;\n      font-size: 0.8em;\n      color: #000000;\n      border-top: 1px solid #000000;\n      padding-top: 10px;\n    }\n    ol { margin-left: 25px; color: #000000; }\n    .answer-space {\n      border-bottom: 1px solid #000000;\n      height: 25px;\n      margin: 5px 0 15px;\n    }\n  </style>\n</head>\n<body>\n\n  <!-- Cover Page -->\n  <div class=\"cover\">\n    <h1>${title}</h1>\n    <h2>${author}</h2>\n    <p>Workbook Summary</p>\n    <p><em>Generated by Megyk Books</em></p>\n  </div>\n\n  <!-- Table of Contents -->\n  <h2>Table of Contents</h2>\n  <ol>${toc}</ol>\n`;\n\n// Loop through chapters\nfor (const ch of chapters) {\n  const questions = ch.questions || [];\n  const answers = ch.answers || [];\n\n  // Add to global index\n  questions.forEach((q, i) => {\n    indexEntries.push({\n      chapter_index: ch.chapter_index,\n      chapter_title: cleanTitle(ch.title),\n      question: q,\n      answer: answers[i] || \"\"\n    });\n  });\n\n  html += `\n  <div class=\"chapter\">\n    <h2>Chapter ${ch.chapter_index + 1}: ${cleanTitle(ch.title)}</h2>\n    ${ch.summary ? `<div class=\"summary\"><p>${ch.summary}</p></div>` : \"\"}\n    \n    ${questions.length ? `\n      <h3>Questions for Reflection</h3>\n      <ol>\n        ${questions.map(q => `\n          <li>${q}\n            <div class=\"answer-space\"></div>\n            <div class=\"answer-space\"></div>\n          </li>`).join(\"\")}\n      </ol>\n    ` : \"\"}\n  </div>`;\n}\n\n// Add complete book summary\nhtml += `\n  <div class=\"chapter\">\n    <h2>Complete Book Summary</h2>\n    <p>${bookSummary}</p>\n  </div>\n`;\n\n// Add global Q&A Index\nif (indexEntries.length) {\n  html += `\n  <div class=\"chapter\">\n    <h2>Workbook Index â€” All Questions & Answers</h2>\n    <table>\n      <tr><th>Chapter</th><th>Question</th><th>Answer</th></tr>`;\n\n  let lastChapter = \"\";\n  for (const e of indexEntries) {\n    const chapterLabel = e.chapter_title !== lastChapter\n      ? `Chapter ${e.chapter_index + 1}: ${e.chapter_title}`\n      : \"\";\n    html += `\n      <tr>\n        <td>${chapterLabel}</td>\n        <td>${e.question}</td>\n        <td>${e.answer}</td>\n      </tr>`;\n    lastChapter = e.chapter_title;\n  }\n\n  html += `\n    </table>\n  </div>`;\n}\n\n// Footer\nhtml += `\n  <footer>\n    Generated on ${new Date().toLocaleDateString()} by Megyk Books\n  </footer>\n</body>\n</html>\n`;\n\nreturn [{ html }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1824,
          160
        ],
        "id": "be5d1f67-e491-43ba-b1a9-04a75321d33d",
        "name": "Generate Workbook HTML"
      },
      {
        "parameters": {
          "jsCode": "return $input.first().json.output;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1280,
          160
        ],
        "id": "f9d33d5b-adf6-46dd-bb63-346c1bf8fe40",
        "name": "Parse Content"
      },
      {
        "parameters": {
          "jsCode": "// Get the LLM message content (handle array or object safely)\nlet raw = $json;\nif (Array.isArray(raw)) raw = raw[0];\nraw = typeof raw === 'string' ? raw : JSON.stringify(raw);\n\n// Step 1 â€” Remove code fences and trim\nraw = raw.replace(/^```(?:json)?/i, '').replace(/```$/, '').trim();\n\n\n// Step 2 â€” If double-encoded, unescape once\nif (raw.startsWith('\"') && raw.endsWith('\"')) {\n  try {\n    raw = JSON.parse(raw);\n  } catch (e) {\n    // ignore if not actually double encoded\n  }\n}\n\n// Step 3 â€” Find the last closing bracket before trailing junk\nconst lastSquare = raw.lastIndexOf(']');\nconst lastCurly = raw.lastIndexOf('}');\nconst cutoff = Math.max(lastSquare, lastCurly);\nif (cutoff !== -1) raw = raw.slice(0, cutoff + 1);\n\n// Step 4 â€” Attempt to parse the clean portion\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (err) {\n  // If it still fails, try to extract both array and trailing summary manually\n  const match = raw.match(/(\\[.*\\])\\s*,\\s*({.*})/s);\n  if (match) {\n    try {\n      const chapters = JSON.parse(match[1]);\n      const summary = JSON.parse(match[2]);\n      parsed = { chapters, summary };\n    } catch (e2) {\n      parsed = { error: e2.message, snippet: raw.slice(0, 500) };\n    }\n  } else {\n    parsed = { error: err.message, snippet: raw.slice(0, 500) };\n  }\n}\n\nreturn parsed;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1584,
          160
        ],
        "id": "bdb72177-f9d7-498d-bfc6-ab92fc06d296",
        "name": "parse Workbook"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.preferences.style }}",
                      "rightValue": "narrative",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "f73cb591-f577-431d-9a62-a7911e625676"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "narrative"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "5216c0fa-a23c-43d5-9df7-b6872a407df4",
                      "leftValue": "={{ $json.preferences.style }}",
                      "rightValue": "bullet_points",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "bullet_points"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "82fc4562-66cb-4690-bece-a5aff5c322e3",
                      "leftValue": "={{ $json.preferences.style }}",
                      "rightValue": "workbook",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "workbook"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.3,
        "position": [
          528,
          -96
        ],
        "id": "cbbb4f30-2a86-4f74-86cf-fa75d7cac1da",
        "name": "Summary Type"
      },
      {
        "parameters": {
          "jsCode": "/* FULL CODE NODE â€” READY TO PASTE INTO n8n */\n\nconst data = items[0].json;\nconst chapters = data.chapters_summary || data.chapters_summaries || [];\nconst prefs = data.user_preferences || {};\nconst summary = data.complete_book_summary || \"\";\n\nfunction escapeHTML(str = \"\") {\n  return String(str)\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\");\n}\n\nfunction cleanTitle(ch, withNumber = false) {\n  let title = ch.title || \"\";\n  title = title.replace(/^(Chapter\\s*\\d+[:.\\-]?\\s*|[0-9IVXLCDM]+\\s+)/i, \"\").trim();\n  return withNumber ? `Chapter ${ch.chapter_index + 1}: ${title}` : title;\n}\n\n// Pure black for workbook mode\nconst accent = \"#000000\";\n\nlet title = $(\"Merge\").first().json.title;\nlet author = $(\"Merge\").first().json.author;\n\nlet html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>${escapeHTML(title)}</title>\n  <style>\n    body {\n      font-family: \"Georgia\", serif;\n      margin: 0.6in 0.85in;  /* ðŸ”¥ Tighter left/right margins */\n      line-height: 1.7;\n      color: #000;\n      background: #fff;\n    }\n\n    h1, h2, h3 {\n      text-align: center;\n      color: #000;\n    }\n\n    h1 {\n      font-size: 2.4em;\n      border-bottom: 3px solid #000;\n      padding-bottom: 0.3em;\n      margin-bottom: 0.5em;\n    }\n\n    h2 {\n      font-size: 1.4em;\n      margin-top: 2.2em;\n      margin-bottom: 0.4em;\n      border-bottom: 1px solid #000;\n      padding-bottom: 0.2em;\n    }\n\n    h3 {\n      font-size: 1.25em;\n      margin-top: 1.6em;\n      margin-bottom: 0.4em;\n      font-weight: bold;\n    }\n\n    p {\n      text-align: justify;\n      margin: 0.7em 0;\n      text-indent: 1.2em;\n      color: #000;\n      font-size: 1.05em;\n    }\n\n    /* Removed drop-cap â€” replaced with clean first-word emphasis */\n    p:first-line {\n      font-weight: 600;\n      letter-spacing: 0.3px;\n      font-size: 1.06em;\n    }\n\n    .summary-intro {\n      background: #fff;\n      border-left: 4px solid #000;\n      padding: 1em 1.5em;\n      margin: 1.5em auto 2em;\n      width: 85%;\n    }\n\n    #toc {\n      background: #fff;\n      border: 1px solid #000;\n      padding: 1em;\n      margin: 2em auto;\n      width: 80%;\n    }\n\n    article {\n      margin-top: 1.8em;\n      padding-top: 1em;\n      border-top: 2px solid #000;\n      background: #fff;\n    }\n\n    footer {\n      text-align: center;\n      margin-top: 3em;\n      font-size: 0.85em;\n      border-top: 1px solid #000;\n      padding-top: 10px;\n    }\n\n    @page {\n      margin: 0.6in 0.7in;\n    }\n\n    @media print {\n      body { margin: 0; }\n      article { page-break-inside: avoid; }\n      #toc, #overview { page-break-inside: avoid; }\n      #overview {\n        page-break-inside: auto !important;\n      }\n\n    }\n  </style>\n</head>\n<body>\n\n  <section id=\"cover\">\n    <h1>${escapeHTML(title)}</h1>\n    <h3>${escapeHTML(author)}</h3>\n    <h3>Megyk Books Summary â€” Narrative Style</h3> \n  </section>\n\n  <section id=\"overview\">\n    <h2>Overview</h2>\n    <p>${escapeHTML(summary)}</p>\n  </section>\n\n  <section id=\"toc\">\n    <h2>Table of Contents</h2>\n    <ol>\n      ${chapters.map(ch => `<li>${escapeHTML(cleanTitle(ch, false))}</li>`).join(\"\")}\n    </ol>\n  </section>\n\n  <section id=\"chapters\">\n    <h2>Chapters</h2>\n`;\n\nfor (const ch of chapters) {\n  html += `\n    <article>\n      <h3>${escapeHTML(cleanTitle(ch, false))}</h3>\n      <p>${escapeHTML(ch.summary)}</p>\n    </article>\n  `;\n}\n\nhtml += `\n  </section>\n\n  <footer>\n    Generated by <strong>Megyk Books</strong> â€” ${new Date().toLocaleDateString()}\n  </footer>\n\n</body>\n</html>\n`;\n\nreturn [{ json: { html } }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1584,
          -320
        ],
        "id": "362e4f44-8f68-415b-bfe8-bea99fdb7cad",
        "name": "Generate Narrative HTML"
      },
      {
        "parameters": {
          "jsCode": "// Input: { user_preferences, chapters_summary[], complete_book_summary }\n// Output: { html: \"<html>...</html>\" }\n\nconst data = items[0].json;\nconst prefs = data.user_preferences || {};\nconst chapters = data.chapters_summary || [];\nconst summary = data.complete_book_summary || \"\";\n\nfunction toList(content) {\n  if (!content) return \"\";\n  if (Array.isArray(content)) {\n    return `<ul>${content.map(b => `<li>${b.trim()}</li>`).join(\"\\n\")}</ul>`;\n  }\n  const sentences = content\n    .split(/(?<=[.?!])\\s+/)\n    .map(s => s.trim())\n    .filter(Boolean);\n  return `<ul>${sentences.map(s => `<li>${s}</li>`).join(\"\\n\")}</ul>`;\n}\n\nfunction cleanTitle(ch, withNumber = false) {\n  let title = ch.title || \"\";\n  title = title.replace(/^(Chapter\\s*\\d+[:.\\-]?\\s*|[0-9IVXLCDM]+\\s+)/i, \"\").trim();\n  return withNumber ? `Chapter ${ch.chapter_index + 1}: ${title}` : title;\n}\n\nfunction accentColor(length) {\n  switch (length) {\n    case \"1pg\": return \"#000000\";\n    case \"15pg\": return \"#000000\";\n    default: return \"#000000\";\n  }\n}\nconst accent = accentColor(prefs.length);\n\nlet title = $(\"Merge\").first().json.title;\nlet author = $(\"Merge\").first().json.author;\n\nlet html = `\n<!DOCTYPE html>\n<html>\n<head>\n<meta charset=\"utf-8\">\n<title>${title}</title>\n<style>\n  body {\n    font-family: \"Helvetica Neue\", Arial, sans-serif;\n    margin: 1in;\n    line-height: 1.6;\n    color: #000000;\n    background: #FFFFFF;\n  }\n  h1, h2, h3 { color: #000000; }\n  h1 {\n    text-align: center;\n    border-bottom: 3px solid #000000;\n    padding-bottom: 10px;\n    margin-bottom: 30px;\n    font-size: 2.2em;\n  }\n  h2 {\n    color: #000000;\n    border-bottom: 1px solid #000000;\n    padding-bottom: 4px;\n    margin-bottom: 0.6em;\n    margin-top: 2em;\n    font-size: 1.3em;\n  }\n  h3 {\n    color: #000000;\n    margin-top: 1.5em;\n    font-size: 1.1em;\n  }\n  ul {\n    list-style-type: disc;\n    margin-left: 1.5em;\n    line-height: 1.5;\n    color: #000000;\n  }\n  li { margin-bottom: 0.3em; color: #000000; }\n  .prefs {\n    background: #FFFFFF;\n    border-left: 4px solid #000000;\n    padding: 1em;\n    margin-bottom: 2em;\n    border-radius: 0;\n  }\n  #overall, #toc, article {\n    page-break-inside: avoid;\n  }\n  #overall {\n    background: #FFFFFF;\n    border-left: 4px solid #000000;\n    padding: 1.2em;\n    border-radius: 0;\n    margin-bottom: 2em;\n  }\n  #toc {\n    background: #FFFFFF;\n    border: 1px solid #000000;\n    border-radius: 0;\n    padding: 1em;\n    margin-bottom: 2em;\n    color: #000000;\n  }\n  #toc h2 {\n    border: none;\n    color: #000000;\n    margin-bottom: 0.5em;\n  }\n  #toc ol {\n    margin-left: 1.5em;\n    line-height: 1.5;\n    color: #000000;\n  }\n  #chapters {\n    page-break-before: always;\n  }\n  article {\n    margin-top: 2em;\n    padding: 1em;\n    border-top: 2px solid #000000;\n    background: #FFFFFF;\n    color: #000000;\n  }\n  article:nth-child(even) {\n    background: #FFFFFF;\n  }\n  footer {\n    margin-top: 50px;\n    text-align: center;\n    font-size: 0.8em;\n    color: #000000;\n    border-top: 1px solid #000000;\n    padding-top: 10px;\n  }\n  footer strong { color: #000000; }\n\n\n    @page {\n      margin: 0.6in 0.7in;\n    }\n\n  @media print {\n    body { margin: 0; }\n    h1, h2, h3, li, p { color: #000000 !important; background: #FFFFFF !important; }\n    #overall, #toc, article { page-break-inside: avoid; }\n    #chapters { page-break-before: always; }\n  }\n</style>\n</head>\n<body>\n\n<h1>${title}</h1>\n<h2>${author}</h2>\n\n<div class=\"prefs\">\n  <p><strong>Style:</strong> ${prefs.style || \"bullet_points\"}</p>\n  <p><strong>Target Length:</strong> ${prefs.length || \"unspecified\"}</p>\n</div>\n\n<section id=\"overall\">\n  <h2>Overall Summary</h2>\n  ${toList(summary)}\n</section>\n\n<section id=\"toc\">\n  <h2>Table of Contents</h2>\n  <ol>\n    ${chapters.map(ch => `<li>${cleanTitle(ch, false)}</li>`).join(\"\\n\")}\n  </ol>\n</section>\n\n<section id=\"chapters\">\n  <h2>Chapters</h2>\n`;\n\nfor (const ch of chapters) {\n  const bullets = ch.summary_bullets || ch.summary || [];\n  html += `\n  <article>\n    <h3>${cleanTitle(ch, false)}</h3>\n    ${toList(bullets)}\n  </article>\n  `;\n}\n\nhtml += `\n</section>\n\n<footer>\n  <p>Generated by <strong>Megyk Books</strong> â€” ${new Date().toLocaleDateString()}</p>\n</footer>\n\n</body>\n</html>\n`;\n\nreturn [{ json: { html } }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1584,
          -80
        ],
        "id": "305e4c5c-ced5-483e-9765-d62a136555c3",
        "name": "Generate Bullet Points HTML"
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n  \"user_preferences\": {\"style\": \"workbook\", \"length\": \"5pg\"},\n  \"chapters_summary\": [\n    {\n      \"chapter_index\": 1,\n      \"title\": \"Chapter Title\",\n      \"summary\": \"Short paragraph summary.\",\n      \"questions\": [\"Question 1\", \"Question 2\"],\n      \"answers\": [\"Answer 1\", \"Answer 2\"]\n    }\n  ],\n  \"complete_book_summary\": \"Overall workbook summary text.\",\n  \"index\": [\n    {\"question\": \"Question 1\", \"answer\": \"Answer 1\"},\n    {\"question\": \"Question 2\", \"answer\": \"Answer 2\"}\n  ]\n}\n",
          "autoFix": true
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          1232,
          416
        ],
        "id": "d57816ff-032b-45c5-bcb4-50c87f829882",
        "name": "Structured Output Parser"
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "value": "gpt-4.1-mini",
            "mode": "list",
            "cachedResultName": "gpt-4.1-mini"
          },
          "options": {
            "temperature": 0.2,
            "timeout": 600000
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          736,
          416
        ],
        "id": "ed35e3be-5b57-4f47-bb59-af1786c7c4ee",
        "name": "OpenAI Chat Model",
        "credentials": {
          "openAiApi": {
            "id": "BRRf66J5aSwt4UDP",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Summarize this book in narrative style using the data retrieved from the Get Chapters tool in accordance with the following preferences object: {{ JSON.stringify($json.preferences) }}\n\nBook Title is: {{ $json.title }}\nAuthor is: {{ $json.author }}\n\n1. Call Get Chapters to fetch all chapters where book_id = {{ $json.book_id }}.\n2. Summarize each chapter as immersive, flowing prose (not meta commentary).\n3. At the end, include a cohesive full-book narrative summary.\n4. Adjust level of detail according to the user_preferences.length value:\n\n- \"1pg\": 1 sentence per chapter; 1 short paragraph overall summary.\n- \"5pg\": ~50-100 words per chapter; 2â€“3 paragraphs overall summary.\n- \"15pg\": 1 page per chapter; multi-paragraph in-depth summary.\n\nReturn only structured JSON matching the format defined in the system prompt.\n",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "=You are a summarization model that writes cohesive, immersive, narrative-style summaries of books.\n\nYou have access to:\n- Get Chapters â€” use this to load all chapters for a given book_id.\n\nThere is an incoming user_preferences object (e.g. {\"style\":\"narrative\",\"length\":\"5pg\"}).\nUse it to adjust tone and detail level.\n\nGuidelines:\n- Write in flowing narrative prose as if retelling the book directly to the reader.\n- Do not say â€œThis chapter discussesâ€¦â€ or â€œThe author explainsâ€¦â€ â€” simply convey the ideas themselves.\n- Write as if you are condensing the book itself, not describing it.\n- Maintain consistent voice and tense throughout.\n- Be accurate, concise, and engaging.\n\nOutput only structured JSON in the format:\n{\n  \"user_preferences\": {...},\n  \"chapters_summary\": [\n    {\"chapter_index\": 1, \"title\": \"Chapter 1\", \"summary\": \"Narrative paragraph...\"}\n  ],\n  \"complete_book_summary\": \"Full book-level narrative summary.\"\n}\n"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 2.2,
        "position": [
          864,
          -320
        ],
        "id": "7e72b5ca-49f2-47d2-8b52-c0cae6909656",
        "name": "Narrative Summary Agent"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Call Get Chapters to retrieve all chapters for the specified book_id: {{ $json.book_id }}\n\nYou have access to the following user preferences object:\n{{ JSON.stringify($json.preferences) }}\n\nBook Title is: {{ $json.title }}\nAuthor is: {{ $json.author }}\n\n\nSummarize each chapter as a list of concise bullet points.\n\nUse the \"length\" parameter to control the level of detail:\n- \"1pg\": Very short â€” 2â€“4 bullets per chapter, focusing only on the core message.\n- \"5pg\": Moderate â€” 6â€“10 bullets per chapter, capturing key ideas and examples.\n- \"15pg\": Extensive â€” 12â€“20 bullets per chapter, covering subtopics, supporting evidence, and nuanced insights.\n\nAt the end, include a bullet-point list of overarching takeaways, scaled to the same level of detail.\n\nReturn JSON in this format:\n{\n  \"user_preferences\": {\"style\": \"bullet_points\", \"length\": \"5pg\"},\n  \"chapters_summary\": [\n    {\"chapter_index\": 1, \"title\": \"Chapter Title\", \"summary_bullets\": [\"â€¢ point 1\", \"â€¢ point 2\", \"â€¢ point 3\"]}\n  ],\n  \"complete_book_summary\": [\"â€¢ main insight 1\", \"â€¢ main insight 2\", \"â€¢ main insight 3\"]\n}\n",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "You are a summarization model that produces high-level bullet point summaries of each chapter of a book.\nYou have access to:\n- Get Chapters â€” use this to load all chapters for a given book_id.\n\nDo not include conversational framing. Respond strictly in JSON matching the example structure."
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 2.2,
        "position": [
          864,
          -80
        ],
        "id": "6b3a9bac-a63d-4ae3-9af9-c439f84667f1",
        "name": "Bullet Points Summary Agent"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Call Get Chapters to retrieve all chapters for the specified book_id: {{ $json.book_id }}\n\nYou have access to the following user preferences object:\n{{ JSON.stringify($json.preferences) }}\n\nBook Title is: {{ $json.title }}\nAuthor is: {{ $json.author }}\n\n\nSummarize each chapter as a clear, workbook-style study section. For each chapter:\n- Write a summary scaled to the \"length\" preference.\n- Generate comprehension questions and concise answers, as follows:\n  - \"1pg\": 1â€“2 simple comprehension questions.\n  - \"5pg\": 3â€“5 moderate-depth questions covering key ideas and examples.\n  - \"15pg\": 6â€“8 in-depth questions exploring reasoning, implications, and context.\n\nAfter summarizing all chapters, include:\n- A \"complete_book_summary\" â€” a brief synthesis of the book as a whole, scaled to the same level of detail.\n- An \"index\" array mapping every question and answer pair across all chapters.\n\nReturn JSON strictly in this format:\n{\n  \"user_preferences\": {\"style\": \"workbook\", \"length\": \"5pg\"},\n  \"chapters_summary\": [\n    {\n      \"chapter_index\": 1,\n      \"title\": \"Chapter Title\",\n      \"summary\": \"Short descriptive paragraph(s)\",\n      \"questions\": [\"Question 1\", \"Question 2\"],\n      \"answers\": [\"Answer 1\", \"Answer 2\"]\n    }\n  ],\n  \"complete_book_summary\": \"Concise book overview\",\n  \"index\": [{\"question\": \"Question 1\", \"answer\": \"Answer 1\"}]\n}\n",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "=You are an educational summarization model that generates workbook-style study guides.\n\nTools:\n- Get Chapters â€” fetches chapters by book_id.\n\nInstructions:\n1. Summarize each chapter clearly and briefly, adjusting depth based on user_preferences.length.\n2. Generate comprehension questions and concise answers. The number of questions should scale by length:\n   - \"1pg\": 1â€“2 simple comprehension questions.\n   - \"5pg\": 3â€“5 medium-depth questions covering key ideas.\n   - \"15pg\": 6â€“8 in-depth questions that explore examples, reasoning, and implications.\n3. Append a combined \"index\" mapping all questions and answers.\n4. Respect the provided user_preferences object for style and length.\n5. Limit each summary to 1â€“2 short paragraphs for \"1pg\", up to 3 for \"5pg\", and up to 5 for \"15pg\".\n\nOutput strictly as JSON in this shape:\n{\n  \"user_preferences\": {...},\n  \"chapters_summary\": [\n    {\n      \"chapter_index\": 1,\n      \"title\": \"...\",\n      \"summary\": \"...\",\n      \"questions\": [\"...\"],\n      \"answers\": [\"...\"]\n    }\n  ],\n  \"complete_book_summary\": \"...\",\n  \"index\": [{\"question\": \"...\", \"answer\": \"...\"}]\n}\n\nGuidelines:\n- Avoid prefatory or conversational text.\n- Prefer clarity and educational usefulness over literary style.\n- Make questions and answers self-contained and directly tied to the chapterâ€™s ideas.\n"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 2.2,
        "position": [
          864,
          160
        ],
        "id": "260cab7c-7f91-49dc-a142-a44e1084a754",
        "name": "Workbook Agent",
        "retryOnFail": false
      },
      {
        "parameters": {
          "jsCode": "return JSON.parse( $input.first().json.output);"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1280,
          -80
        ],
        "id": "49968360-b149-46da-a157-b598e3cea933",
        "name": "Parse Output"
      },
      {
        "parameters": {
          "jsCode": "return JSON.parse( $input.first().json.output);"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1280,
          -320
        ],
        "id": "d08aee05-f94a-4635-92cd-290551b8a2c1",
        "name": "Parse Output1"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "get_book_summary",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -592,
          -64
        ],
        "id": "1ab0665d-531f-4272-bd9a-e65642f382da",
        "name": "Webhook",
        "webhookId": "057f4390-ae36-4e89-81ea-78d92b2a53b9"
      },
      {
        "parameters": {
          "respondWith": "binary",
          "options": {
            "responseCode": 200,
            "responseHeaders": {
              "entries": [
                {
                  "name": "Content-Type",
                  "value": "application/pdf"
                },
                {
                  "name": "Content-Disposition",
                  "value": "attachment; filename=\"document.pdf\""
                }
              ]
            }
          }
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.4,
        "position": [
          2560,
          -80
        ],
        "id": "c3fb6559-f2bf-4186-baae-e24a5652b591",
        "name": "Respond to Webhook"
      },
      {
        "parameters": {
          "jsCode": "// Extract the body payload from the webhook input\nconst body = items[0].json.body;\n\nreturn [\n  {\n    json: {\n      book_id: body.book_id,     // maps from book_id\n      user_id: 'bfb1e2f2-353c-4cf7-807e-4be63ed7cfff',        // placeholder if not provided\n      preferences: body.preferences\n    }\n  }\n];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -352,
          -64
        ],
        "id": "52dd94ac-dec8-4cb7-b5c6-3c88b36b9c2f",
        "name": "Parse Incoming"
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "chapters",
          "filters": {
            "conditions": [
              {
                "keyName": "book_id",
                "condition": "eq",
                "keyValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Field_Value', ``, 'string') }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          992,
          416
        ],
        "id": "0949ffd9-d2bd-4c69-8e4f-5a4edcbb85b6",
        "name": "Get Chapters",
        "credentials": {
          "supabaseApi": {
            "id": "fdzgJDGuPA2JozKn",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4.1-mini"
          },
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          720,
          128
        ],
        "id": "9da8e45b-fd0d-44b8-b895-a11345edec80",
        "name": "OpenAI Chat Model1",
        "credentials": {
          "openAiApi": {
            "id": "BRRf66J5aSwt4UDP",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4.1-mini"
          },
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          720,
          -112
        ],
        "id": "257ecacc-0eec-492f-9900-f805b26cfd82",
        "name": "OpenAI Chat Model2",
        "credentials": {
          "openAiApi": {
            "id": "BRRf66J5aSwt4UDP",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "mode": "combine",
          "advanced": true,
          "mergeByFields": {
            "values": [
              {
                "field1": "id",
                "field2": "book_id"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          64,
          -80
        ],
        "id": "ed45a8aa-749f-4820-adc2-ee86696bb775",
        "name": "Merge"
      },
      {
        "parameters": {
          "operation": "get",
          "tableId": "books",
          "filters": {
            "conditions": [
              {
                "keyName": "id",
                "keyValue": "={{ $json.book_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -144,
          -192
        ],
        "id": "e378404a-2aa6-4b6f-ac42-aefb9eb16625",
        "name": "Load Book",
        "credentials": {
          "supabaseApi": {
            "id": "fdzgJDGuPA2JozKn",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4.1-mini"
          },
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          1168,
          624
        ],
        "id": "3e98676d-c0f7-46e6-b2db-56ed11f4ac55",
        "name": "OpenAI Chat Model3",
        "credentials": {
          "openAiApi": {
            "id": "BRRf66J5aSwt4UDP",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://pdf.megyk.com/html-to-pdf",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "html",
                "value": "={{ $json.html }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          2304,
          -80
        ],
        "id": "277822f1-04dc-4888-b616-495b8a71a7b8",
        "name": "HTML 2 PDF Service",
        "credentials": {
          "httpHeaderAuth": {
            "id": "AK2nObMbf1AjgZti",
            "name": "PDF Service API Key"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "93bcaa67-5d39-4eee-96ce-900e357530cc",
                "name": "html",
                "value": "={{ $json.html }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          2048,
          -80
        ],
        "id": "dd4655d8-9d01-48ff-b84f-94823a0a971e",
        "name": "Edit Fields"
      }
    ],
    "connections": {
      "Generate Workbook HTML": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Content": {
        "main": [
          [
            {
              "node": "parse Workbook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "parse Workbook": {
        "main": [
          [
            {
              "node": "Generate Workbook HTML",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Summary Type": {
        "main": [
          [
            {
              "node": "Narrative Summary Agent",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Bullet Points Summary Agent",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Workbook Agent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Generate Narrative HTML": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Generate Bullet Points HTML": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "Workbook Agent",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "Workbook Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Bullet Points Summary Agent": {
        "main": [
          [
            {
              "node": "Parse Output",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Narrative Summary Agent": {
        "main": [
          [
            {
              "node": "Parse Output1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Workbook Agent": {
        "main": [
          [
            {
              "node": "Parse Content",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Output": {
        "main": [
          [
            {
              "node": "Generate Bullet Points HTML",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Output1": {
        "main": [
          [
            {
              "node": "Generate Narrative HTML",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook": {
        "main": [
          [
            {
              "node": "Parse Incoming",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Incoming": {
        "main": [
          [
            {
              "node": "Load Book",
              "type": "main",
              "index": 0
            },
            {
              "node": "Merge",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Get Chapters": {
        "ai_tool": [
          [
            {
              "node": "Workbook Agent",
              "type": "ai_tool",
              "index": 0
            },
            {
              "node": "Bullet Points Summary Agent",
              "type": "ai_tool",
              "index": 0
            },
            {
              "node": "Narrative Summary Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model1": {
        "ai_languageModel": [
          [
            {
              "node": "Bullet Points Summary Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model2": {
        "ai_languageModel": [
          [
            {
              "node": "Narrative Summary Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Merge": {
        "main": [
          [
            {
              "node": "Summary Type",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Load Book": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model3": {
        "ai_languageModel": [
          [
            {
              "node": "Structured Output Parser",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "HTML 2 PDF Service": {
        "main": [
          [
            {
              "node": "Respond to Webhook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "HTML 2 PDF Service",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Gordan Kljajic",
    "name": null,
    "description": null
  },
  "tags": []
}